{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "newStorageAccountNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "The prefix of the new storage account created to store the VMs disks, three different storage accounts will be created using this string as a prefix for the name"
      }
    },

    "storageAccountType": {
      "type": "string",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "The type of the Storage Account created"
      },
      "defaultValue": "Standard_LRS"
    },

    "vmNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "The Prefix for the Vms"
      }
    },

    "adVMSize": {
      "type": "string",
      "allowedValues": [
        "Standard_A2",
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ],
      "metadata": {
        "description": "The size of the AD VMs Created"
      },
      "defaultValue": "Standard_A2"
    },

    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The domain name"
      }
    },

    "AZWENetworkSubnet": {
      "type": "string",
      "metadata": {
        "description": "The address range of the subnet static IPs are allocated from in the AZWE VNET"
      },
      "defaultValue": "10.210.0.0/16"
    },
    "AZWECoreSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "The address range of the Core subnet in CIDR format"
      },
      "defaultValue": "10.210.1.0/24"
    },
    "AZWETMDSSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "The address range of the TMDS subnet in CIDR format"
      },
      "defaultValue": "10.210.10.0/24"
    },

    "primaryAdIpAddress": {
      "type": "string",
      "metadata": {
        "description": "The address of Primary AD"
      },
      "defaultValue": "10.210.1.11"
    },

    "secondaryIpAddress": {
      "type": "string",
      "metadata": {
        "description": "The address of secondary AD"
      },
      "defaultValue": "10.210.1.12"
    },

    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the Administrator of the new VMs and Domain"
      },
      "defaultValue": "azureadmin"
    },

    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Administrator account of the new VMs and Domain"
      }
    },

    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources that the script is dependent on such as linked templates and DSC modules"
      },
      "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/sql-server-2014-alwayson-dsc"
    },

    "location": {
      "type": "string",
      "allowedValues": [
        "North Europe",
        "West Europe"
      ],
      "metadata": {
        "description": "The region to deploy the resources into"
      }
    }
  },
  "variables": {
    "staticCoreSubnetName": "AZWECoreSubnet",
    "staticTMDSSubnetName": "AZWETMDSSubnet",
    "subnets": [
      {
        "name": "[variables('staticCoreSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('AZWECoreSubnetPrefix')]"
        }
      },
      {
        "name": "[variables('staticTMDSSubnetName')]",
        "properties": {
          "addressPrefix": "[parameters('AZWETMDSSubnetPrefix')]"
        }
      }
    ],
    "virtualNetworkName": "AZWEVNET",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "staticSubnetRef": "[concat(variables('vnetID'),'/subnets/',variables('staticCoreSubnetName'))]",
    "adTemplateURL": "[concat(parameters('assetLocation'),'/ADVmTemplate.json')]",


    "adStorageName": "[concat(parameters('newStorageAccountNamePrefix'),'adsa')]",
    "adVmDepoyment": "DeployAdVms",
    "adVmDepoymentId": "[concat('Microsoft.Resources/deployments/', variables('adVmDepoyment'))]",
    "deployPrimaryAdTemplateURL": "[concat(parameters('assetLocation'),'/DeployPrimaryAD.json')]",
    "deploySecondaryAdTemplateURL": "[concat(parameters('assetLocation'),'/DeploySecondaryAD.json')]",
    "deployPrimaryAd": "deployPrimaryAd",
    "deployPrimaryAdId": "[concat('Microsoft.Resources/deployments/', variables('deployPrimaryAd'))]",
    "deploySecondaryAdName": "deploySecondaryAdName",
    "deploySecondaryAdNameId": "[concat('Microsoft.Resources/deployments/', variables('deploySecondaryAdName'))]",

    "adPDCVMName": "[concat(parameters('vmNamePrefix'),'-ISADCP101')]",
    "adBDCVMName": "[concat(parameters('vmNamePrefix'),'-ISADCP102')]",

    "vnetwithDNSTemplateUri": "[concat(parameters('assetLocation'),'/vnet-with-dns-server.json')]",
    "updateVNetDNS1": "updateVNetDNS1",
    "updateVNetDNS1Id": "[concat('Microsoft.Resources/deployments/', variables('updateVNetDNS1'))]",

    "updateVNetDNS2": "updateVNetDNS2",
    "updateVNetDNS2Id": "[concat('Microsoft.Resources/deployments/', variables('updateVNetDNS2'))]",

    "nicTemplateURL": "[concat(parameters('assetLocation'),'/nic.json')]"
     
  },

  "resources": [
    {
      "name": "[variables('virtualNetworkName')]",
      "type": "Microsoft.Network/virtualNetworks",
      "location": "[parameters('location')]",
      "apiVersion": "2015-05-01-preview",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('AZWENetworkSubnet')]"
          ]
        },
        "subnets": "[variables('subnets')]"
      }
    },
    {
      "name": "[variables('adVmDepoyment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('virtualNetworkName')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('adTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": { "value": "[parameters('location')]" },
          "adminUsername": { "value": "[parameters('adminUsername')]" },
          "adminPassword": { "value": "[parameters('adminPassword')]" },
          "storageAccount": { "value": "[variables('adStorageName')]" },
          "subnetUri": { "value": "[variables('staticSubnetRef')]" },
          "primaryAdIpAddress": { "value": "[parameters('primaryAdIpAddress')]" },
          "secondaryIpAddress": { "value": "[parameters('secondaryIpAddress')]" },
          "storageAccountType": { "value": "[parameters('storageAccountType')]" },
          
          "vmSize": { "value": "[parameters('adVMSize')]" }
        }
      }
    },
    {
      "name": "[variables('deployPrimaryAd')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('adVmDepoymentId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('deployPrimaryAdTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "primaryADName": { "value": "[variables('adPDCVMName')]" },
          "domainName": { "value": "[parameters('domainName')]" },
          "location": { "value": "[parameters('location')]" },
          "adminUsername": { "value": "[parameters('adminUsername')]" },
          "adminPassword": { "value": "[parameters('adminPassword')]" },
          "assetLocation": { "value": "[parameters('assetLocation')]" }
        }
      }
    }
    ,
    {
      "name": "[variables('updateVNetDNS1')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('deployPrimaryAdId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetwithDNSTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": { "value": "[parameters('location')]" },
          "virtualNetworkName": { "value": "[variables('virtualNetworkName')]" },
          "virtualNetworkAddressRange": { "value": "[parameters('AZWENetworkSubnet')]" },
          "subnets": { "value": "[variables('subnets')]" },
          "dnsServerAddress": { "value": [ "[parameters('primaryAdIpAddress')]" ] }
        }
      }
    },
    {
      "name": "[variables('deploySecondaryAdName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('updateVNetDNS1Id')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('deploySecondaryAdTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "secondaryADName": { "value": "[variables('adBDCVMName')]" },
          "domainName": { "value": "[parameters('domainName')]" },
          "location": { "value": "[parameters('location')]" },
          "adminUsername": { "value": "[parameters('adminUsername')]" },
          "adminPassword": { "value": "[parameters('adminPassword')]" },
          "assetLocation": { "value": "[parameters('assetLocation')]" }
        }
      }
    },
    {
      "name": "[variables('updateVNetDNS2')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[variables('deploySecondaryAdNameId')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vnetwithDNSTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": { "value": "[parameters('location')]" },
          "virtualNetworkName": { "value": "[variables('virtualNetworkName')]" },
          "virtualNetworkAddressRange": { "value": "[parameters('AZWENetworkSubnet')]" },
          "subnets": { "value": "[variables('subnets')]" },
          "dnsServerAddress": { "value": [ "[parameters('primaryAdIpAddress')]", "[parameters('secondaryIpAddress')]" ] }
        }
      }
    }
  ],

  "outputs": {
  }
}
